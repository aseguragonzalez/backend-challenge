services:

  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: api
    depends_on:
    - db
    - db-init
    - rabbitmq
    env_file:
    - .env
    networks:
    - default
    ports:
    - 8000:8000
    volumes:
    - .:/home/app

  dlq:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dlq
    command: python src/infrastructure/ports/dlq/main.py
    depends_on:
    - db
    - db-init
    - rabbitmq
    env_file:
    - .env
    networks:
    - default
    volumes:
    - .:/home/app

  publisher:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: publisher
    command: python src/infrastructure/ports/publisher/main.py
    depends_on:
    - db
    - db-init
    - rabbitmq
    env_file:
    - .env
    networks:
    - default
    volumes:
    - .:/home/app

  subscriber:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: subscriber
    command: python src/infrastructure/ports/subscriber/main.py
    depends_on:
    - db
    - db-init
    - rabbitmq
    env_file:
    - .env
    networks:
    - default
    volumes:
    - .:/home/app

  db:
    build:
      context: ./deploy/mongodb/
      dockerfile: ./Dockerfile
    container_name: db
    networks:
    - default
    ports:
    - 27017:27017
    volumes:
    - mongo-data:/data/db

  db-init:
    build:
      context: ./deploy/mongodb-init/
      dockerfile: ./Dockerfile
    container_name: db-init
    depends_on:
    - db
    env_file:
    - ./deploy/mongodb-init/.env
    networks:
    - default

  rabbitmq:
    build:
      context: ./deploy/rabbitmq/
      dockerfile: ./Dockerfile
    container_name: rabbitmq
    networks:
    - default
    ports:
    - 5672:5672
    - 15672:15672

  slack:
    container_name: slack
    build:
      context: ./deploy/slack/
      dockerfile: ./Dockerfile
    networks:
    - default
    ports:
    - 8080:8080
    - 8443:8443

  smtp:
    image: rnwood/smtp4dev
    container_name: smtp
    env_file:
    - ./deploy/smtp/.env
    networks:
    - default
    ports:
    - 8180:80

volumes:
  mongo-data:

networks:
  default:
    name: backend-challenge-network
